<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>Zhaohao Lin</title><meta name="author" content="Lachlan"><link rel="shortcut icon" href="/img/favicon.png"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><meta name="generator" content="Hexo 4.2.0"></head><body><header id="page_header"><div class="header_wrap"><div id="blog_name"><a class="blog_title" id="site-name" href="/">Zhaohao Lin</a></div><button class="menus_icon"><div class="navicon"></div></button><ul class="menus_items"><li class="menus_item"><a class="site-page" href="/"> Publications</a></li><li class="menus_item"><a class="site-page" href="/"> About</a></li><li class="menus_item"><a class="site-page" href="https://lachlanlin.gitee.io/blog/" target="_blank" rel="noopener"> Blog</a></li></ul></div></header><main id="page_main"><div class="side-card sticky"><div class="card-wrap" itemscope itemtype="http://schema.org/Person"><div class="author-avatar"><img class="avatar-img" src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/profile.png'" alt="avatar"></div><div class="author-discrip"><h3>Lachlan</h3><p class="author-bio">Your biography can be writed down here.</p></div><div class="author-links"><button class="btn m-social-links">Links</button><ul class="social-icons"><li><a class="social-icon" href="/" target="_blank"><i class="fab fa-twitter" aria-hidden="true"></i></a></li><li><a class="social-icon" href="/" target="_blank"><i class="fab fa-facebook-square" aria-hidden="true"></i></a></li><li><a class="social-icon" href="/" target="_blank"><i class="fab fa-github" aria-hidden="true"></i></a></li><li><a class="social-icon" href="/" target="_blank"><i class="fab fa-stack-overflow" aria-hidden="true"></i></a></li><li><a class="social-icon" href="/" target="_blank"><i class="fab fa-linkedin" aria-hidden="true"></i></a></li><li><a class="social-icon" href="/" target="_blank"><i class="fab fa-weibo" aria-hidden="true"></i></a></li><li><a class="social-icon" href="/" target="_blank"><i class="fab fa-weixin" aria-hidden="true"></i></a></li><li><a class="social-icon" href="/" target="_blank"><i class="fab fa-qq" aria-hidden="true"></i></a></li><li><a class="social-icon" href="/" target="_blank"><i class="fas fa-envelope" aria-hidden="true"></i></a></li><li><a class="social-icon" href="/" target="_blank"><i class="fas fa-rss" aria-hidden="true"></i></a></li></ul><ul class="social-links"><li><a class="e-social-link" href="/" target="_blank"><i class="fas fa-graduation-cap" aria-hidden="true"></i><span>Google Scholar</span></a></li><li><a class="e-social-link" href="/" target="_blank"><i class="fab fa-orcid" aria-hidden="true"></i><span>ORCID</span></a></li></ul></div><a class="cv-links" href="/attaches/CV.pdf" target="_blank"><i class="fas fa-file-pdf" aria-hidden="true"><span>My Detail CV.</span></i></a></div></div><div class="page" itemscope itemtype="http://schema.org/CreativeWork"><h2 class="page-title">我开发的mrcnn的ros包</h2><article><h1 id="我的Mask-R-CNN的ROS包"><a href="#我的Mask-R-CNN的ROS包" class="headerlink" title="我的Mask-R-CNN的ROS包"></a>我的Mask-R-CNN的ROS包</h1><p>主要工作是将<a href="https://github.com/matterport/Mask_RCNN" target="_blank" rel="noopener">matterport/Mask_RCNN</a>套入到ROS的框架中</p>
<h2 id="功能介绍"><a href="#功能介绍" class="headerlink" title="功能介绍"></a>功能介绍</h2><h3 id="Parameters"><a href="#Parameters" class="headerlink" title="Parameters"></a>Parameters</h3><ul>
<li>~coco_path: string<br>  coco文件夹的地址, 默认是包文件夹下的scripts/coco/</li>
<li>~coco_model_path: string<br>  从coco数据集训练出来的权重, 默认是包文件夹下的mask_rcnn_coco.h5</li>
</ul>
<h2 id="Topics-Published"><a href="#Topics-Published" class="headerlink" title="Topics Published"></a>Topics Published</h2><ul>
<li>/mrcnn_image: sensor_msgs/Image<br>  经过mask-r-cnn识别之后的图片可视化</li>
<li>/mrcnn_result: mask_rcnn/mrcnn_result<br>  自定义的数据格式, 详情见mrcnn_result.msg, 是经过mask-r-cnn识别之后的结果, 包括rois, class_ids, class_names, scores</li>
</ul>
<h2 id="Topics-Subscribed"><a href="#Topics-Subscribed" class="headerlink" title="Topics Subscribed"></a>Topics Subscribed</h2><ul>
<li>/usb_cam/image_raw: sensor_msgs/Image<br>  usb_cam包的发布的Topic</li>
</ul>
<h2 id="改造过程"><a href="#改造过程" class="headerlink" title="改造过程"></a>改造过程</h2><h3 id="生成图片"><a href="#生成图片" class="headerlink" title="生成图片"></a>生成图片</h3><p>在matterport/Mask_RCNN的代码中, 图片是直接通过plt.show()显示的, 并没有将图片保存到变量中, 所以我需要将图片保存到变量中. 参考了<a href="https://matplotlib.org/gallery/misc/agg_buffer_to_array.html" target="_blank" rel="noopener">官方教程</a>和一个<a href="https://stackoverflow.com/questions/55261576/plt-plot-to-opencv-image-numpy-array" target="_blank" rel="noopener">stackoverflow</a>, 最终的代码在my_visualize.py中, 如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> matplotlib.figure <span class="keyword">import</span> Figure</span><br><span class="line"><span class="keyword">from</span> matplotlib.backends.backend_agg <span class="keyword">import</span> FigureCanvasAgg</span><br><span class="line"><span class="comment">############################</span></span><br><span class="line"><span class="comment"># somethings</span></span><br><span class="line"><span class="comment">############################</span></span><br><span class="line">fig = Figure()</span><br><span class="line">canvas = FigureCanvasAgg(fig)</span><br><span class="line">ax = fig.gca()</span><br><span class="line"><span class="comment">###########################</span></span><br><span class="line"><span class="comment"># 使用上面创建的ax, 用matplotlib进行绘图</span></span><br><span class="line"><span class="comment">###########################</span></span><br><span class="line">canvas.draw()</span><br><span class="line">result = np.fromstring(canvas.tostring_rgb(), dtype=<span class="string">'uint8'</span>)</span><br><span class="line">result = result.reshape(height, width, <span class="number">3</span>)</span><br><span class="line"><span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>
<h3 id="使用cv-bridge"><a href="#使用cv-bridge" class="headerlink" title="使用cv_bridge"></a>使用cv_bridge</h3><p>在ROS中使用的图片的数据格式是sensor_msgs/Image, 但是在opencv中使用的是numpy.ndarray, 所以两者需要转换, 转换的方式是使用cv_bridge</p>
<img src="/2020/04/03/my-ros-pkg-mrcnn/cvbridge.png" class="" title="cvbridge">
<p>使用方法很简单, 网上可以找到很多教程, 或者看我的代码.<br>!但是, 一开始使用的时候会报错</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ImportError: dynamic module does not define module export function (PyInit_cv_bridge_boost)</span><br></pre></td></tr></table></figure>
<p>产生该报错的原因是因为ROS自己编译的cv_bridge是python2版本, 我是使用python3, 版本不兼容, 所以报错.<br><a href="https://medium.com/@beta_b0t/how-to-setup-ros-with-python-3-44a69ca36674" target="_blank" rel="noopener">解决方法</a>是下载cv_bridage的c++源码, 自己编译并覆盖原本的cv_bridge, 一个细节是, 如果是使用Anaconda, 那么要先将环境deactivate, 另一个细节是在source install/setup.bash时要加参数—extend, 不然这次的setup.bash 会覆盖上一次</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install python-catkin-tools python3-dev python3-numpy</span><br><span class="line"></span><br><span class="line">mkdir ~/catkin_build_ws &amp;&amp; cd ~/catkin_build_ws</span><br><span class="line">catkin config -DPYTHON_EXECUTABLE=/usr/bin/python3 -DPYTHON_INCLUDE_DIR=/usr/include/python3.6m -DPYTHON_LIBRARY=/usr/lib/x86_64-linux-gnu/libpython3.6m.so</span><br><span class="line">catkin config --install</span><br><span class="line"></span><br><span class="line">mkdir src</span><br><span class="line">cd src</span><br><span class="line">git clone -b melodic git@github.com:ros-perception/vision_opencv.git</span><br><span class="line"></span><br><span class="line">cd ~/catkin_build_ws</span><br><span class="line">catkin build cv_bridge</span><br><span class="line">source install/setup.bash --extend</span><br></pre></td></tr></table></figure>
<h3 id="自定义-msg文件"><a href="#自定义-msg文件" class="headerlink" title="自定义.msg文件"></a>自定义.msg文件</h3><p>ROS支持自定义消息的数据格式, 所以我自己也定义了一个mrcnn_result数据格式, , 具体步骤可以看但是, 如果自定义数据格式里包含其他的数据结构, 比如我自定义的这个mrcnn_result, ROS就会报错</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ImportError: No module named 'em'</span><br></pre></td></tr></table></figure>
<p>即使安装了empy也没有效果, 貌似是只能用python2编译的感觉, 所以我新建了一个工作空间(原来的工作空间是用python3的, 会和python2产生冲突), 把代码放到里面, 再编译, 果然成功了, 之后再用python3引用这个工作空间中的数据格式就好</p>
<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>运行过程中的数据流图如图</p>
<img src="/2020/04/03/my-ros-pkg-mrcnn/rosgraph.png" class="" title="rosgraph">
</article></div></main><div class="nav-wrap"><div class="nav"><button class="site-nav"><div class="navicon"></div></button><ul class="nav_items"><li class="nav_item"><a class="nav-page" href="/"> Publications</a></li><li class="nav_item"><a class="nav-page" href="/"> About</a></li><li class="nav_item"><a class="nav-page" href="https://lachlanlin.gitee.io/blog/" target="_blank" rel="noopener"> Blog</a></li></ul></div><div class="cd-top"><i class="fa fa-arrow-up" aria-hidden="true"></i></div></div><footer id="page_footer"><div class="footer_wrap"><div class="copyright">&copy;2020 - 2021 by Lachlan</div><div class="theme-info">Powered by <a href="https://hexo.io" target="_blank" rel="nofollow noopener">Hexo</a> & <a href="https://github.com/PhosphorW/hexo-theme-academia" target="_blank" rel="nofollow noopener">Academia Theme</a></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery-pjax@latest/jquery.pjax.min.js"></script><script src="/js/main.js"></script></body></html>